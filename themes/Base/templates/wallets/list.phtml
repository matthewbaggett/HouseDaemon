<?php
$month_ago = strtotime('1 month ago');
$week_ago = strtotime('1 week ago');
$day_ago = strtotime('1 day ago');
$hour_ago = strtotime('1 hour ago');
?>
<table>
  <thead>
    <tr>
      <td class="coin">Coin</td>
      <td colspan="2">Address</td>
      <td colspan="2">Balance</td>
      <td colspan="4">Rate</td>
    </tr>
    <tr>
      <td></td>
      <td colspan="2"></td>
      <td>Confirmed</td>
      <td>Unconfirmed</td>
      <td>Month</td>
      <td>Week</td>
      <td>Day</td>
      <td>Hour</td>
    </tr>
  </thead>
  <tbody>
  <?php foreach($accounts as $account): ?>
    <?php
    /* @var $account \LoneSatoshi\Models\Account */
    $transactions_count['month']  = \LoneSatoshi\Models\Transaction::search()->where('account_id',$account->account_id)->where('date', date('Y-m-d H:i:s', $month_ago), ">=")->exec();
    $transactions_count['week']   = \LoneSatoshi\Models\Transaction::search()->where('account_id',$account->account_id)->where('date', date('Y-m-d H:i:s', $week_ago), ">=")->exec();
    $transactions_count['day']    = \LoneSatoshi\Models\Transaction::search()->where('account_id',$account->account_id)->where('date', date('Y-m-d H:i:s', $day_ago), ">=")->exec();
    $transactions_count['hour']   = \LoneSatoshi\Models\Transaction::search()->where('account_id',$account->account_id)->where('date', date('Y-m-d H:i:s', $hour_ago), ">=")->exec();

    foreach($transactions_count as $period => &$values){
      $cumulative = 0;
      foreach($values as $transaction){
        /* @var $transaction \LoneSatoshi\Models\Transaction */
        $cumulative = $cumulative + $transaction->amount;
      }
      $values = $cumulative;
    }

    ?>

    <tr>
      <td class="coin"><?php echo $account->get_coin()->name; ?></td>
      <td class="address">
        <?php echo $account->address; ?>
      </td>
      <td class="blockchain">
        <?php if($account->get_coin()->chain_url_format_address && $account->get_coin()->chain_name): ?>
          <a href="<?php echo str_replace("::ADDRESS::", $account->address, $account->get_coin()->chain_url_format_address); ?>">
            <?php echo $account->get_coin()->chain_name; ?>
          </a>
        <?php endif; ?>
      </td>
      <td class="confirmed">
        <?php echo ($account->get_balance_confirmed() instanceof \LoneSatoshi\Models\BalanceConfirmed) ? $account->get_balance_confirmed()->balance : 0; ?>
      </td>
      <td class="unconfirmed">
        <?php echo ($account->get_balance_unconfirmed() instanceof \LoneSatoshi\Models\BalanceUnconfirmed) ? $account->get_balance_unconfirmed()->balance : 0; ?>
      </td>
      <td>
        <?php echo number_format($transactions_count['month'],0); ?>
      </td>
      <td>
        <?php echo number_format($transactions_count['week'],0); ?>
      </td>
      <td>
        <?php echo number_format($transactions_count['day'],0); ?>
      </td>
      <td>
        <?php echo number_format($transactions_count['hour'],0); ?>
      </td>
    </tr>
  <?php endforeach; ?>
  </tbody>
</table>